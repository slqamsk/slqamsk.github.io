<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Журнал Активностей</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        input[type="text"] { width: 70px; }
        button.now-btn { padding: 2px 6px; font-size: 0.8em; margin-left: 5px; vertical-align: middle; }
        button.action-btn { padding: 5px 10px; font-size: 1em; }
        textarea { width: 100%; height: 750px; }
        .date-container { margin: 15px 0; }
        .date-container label { display: inline-block; width: 100px; }
        .date-container input { width: auto; }
        .history-controls { margin: 20px 0; }
        .history-controls select { width: 200px; padding: 5px; margin-right: 10px; }
        .debug-info { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; }
        .debug-info h3 { margin-top: 0; }
        .debug-json { white-space: pre-wrap; word-break: break-all; font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body>

<h1>Журнал Активностей - Версия 06</h1>

<div class="date-container">
    <label for="logDate">Дата:</label>
    <input type="date" id="logDate">
</div>

<table id="activitiesTable">
    <thead>
        <tr>
            <th>Активность</th>
            <th>Описание</th>
            <th>Начало (ЧЧ:ММ)</th>
            <th>Окончание (ЧЧ:ММ)</th>
            <th>Качество (1-5)</th>
            <th>Комментарий</th>
        </tr>
    </thead>
    <tbody id="tbody-content">
        <!-- Content will be generated by script -->
    </tbody>
</table>

<button class="action-btn" onclick="generateJson()">Сгенерировать JSON</button>
<button class="action-btn" onclick="clearAll()">Очистить</button>

<h2>Экспорт:</h2>
<button class="action-btn" onclick="copyToClipboard()">Copy</button>
<textarea id="jsonOutput"></textarea>

<div class="history-controls">
    <label for="historySelect">Выбрать сохранённый день:</label>
    <select id="historySelect">
        <option value="">-- Выберите дату --</option>
    </select>
    <button class="action-btn" onclick="loadFromHistory()">Загрузить дату</button>
</div>

<div class="debug-info">
    <h3>Содержимое LocalStorage:</h3>
    <div id="localStorageContent" class="debug-json"></div>
    <button class="action-btn" onclick="updateDebugInfo()">Обновить</button>
</div>

<script>
    // Типовые активности из Pre-MVP
    const predefinedActivities = [
        { id: 1, name: "Здоровый сон", description: "Ложиться 22:00–24:00, спать ≥8 часов" },
        { id: 2, name: "Утренний ритуал", description: "Почистить зубы, выпить стакан воды, принять душ" },
        { id: 3, name: "Утренняя разминка", description: "Сделать зарядку или растяжку сразу после утреннего ритуала" },
        { id: 4, name: "Горячий завтрак", description: "Есть горячую еду утром" },
        { id: 5, name: "Свежий воздух", description: "Провести время на улице между 10:00 и 18:00" },
        { id: 6, name: "Музыкальная практика", description: "Заниматься музыкой (играть, петь, учиться)" },
        { id: 7, name: "Рабочий блок", description: "Выделить время на осознанную работу" }
    ];

    // Исправленные ключи
    const STORAGE_KEY_DATA = 'lifeMetricsCurrentData'; // Для текущих данных
    const STORAGE_KEY_HISTORY = 'lifeMetricsHistoryData'; // Для истории - исправлено имя

    // Функция для получения текущей даты в формате YYYY-MM-DD
    function getCurrentDate() {
        const today = new Date();
        return today.toISOString().split('T')[0];
    }

    // Загрузка текущих данных при запуске
    function loadFromLocalStorage() {
        const savedData = localStorage.getItem(STORAGE_KEY_DATA);
        if (savedData) {
            try {
                const parsed = JSON.parse(savedData);
                document.getElementById('logDate').value = parsed.date || getCurrentDate();

                predefinedActivities.forEach(activity => {
                    const startId = `start_${activity.id}`;
                    const endId = `end_${activity.id}`;
                    const qualityId = `quality_${activity.id}`;
                    const commentId = `comment_${activity.id}`;

                    if (parsed.entries && parsed.entries[activity.id]) {
                        const entry = parsed.entries[activity.id];
                        if (entry.start_time !== undefined) document.getElementById(startId).value = entry.start_time;
                        if (entry.end_time !== undefined) document.getElementById(endId).value = entry.end_time;
                        if (entry.quality !== undefined) document.getElementById(qualityId).value = entry.quality;
                        if (entry.comment !== undefined) document.getElementById(commentId).value = entry.comment;
                    }
                });
            } catch (e) {
                console.error("Ошибка при загрузке данных из localStorage:", e);
            }
        } else {
            // Если данных нет, установим текущую дату
            document.getElementById('logDate').value = getCurrentDate();
        }
        // Обновляем список истории при загрузке страницы
        updateHistoryList();
        // Обновляем отладочную информацию
        updateDebugInfo();
    }

    // Сохранение текущих данных в localStorage
    function saveCurrentToLocalStorage() {
        const entries = {};
        predefinedActivities.forEach(activity => {
            entries[activity.id] = {
                start_time: document.getElementById(`start_${activity.id}`).value || null,
                end_time: document.getElementById(`end_${activity.id}`).value || null,
                quality: document.getElementById(`quality_${activity.id}`).value || null,
                comment: document.getElementById(`comment_${activity.id}`).value || null
            };
        });

        const dataToSave = {
            date: document.getElementById('logDate').value,
            entries: entries
        };

        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(dataToSave));
    }

    // Сохранение в историю (ИСПРАВЛЕНА)
    function saveToHistory(date, entries) {
        // Исправлено: корректная обработка отсутствия данных
        const historyStr = localStorage.getItem(STORAGE_KEY_HISTORY);
        const history = historyStr ? JSON.parse(historyStr) : {};
        
        // Перезаписываем существующую дату или добавляем новую
        history[date] = {
            date: date,
            entries: entries
        };
        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
        console.log("Сохранена история для даты:", date, history[date]);
        // Обновляем список истории после сохранения
        updateHistoryList();
        // Обновляем отладочную информацию
        updateDebugInfo();
    }

    // Загрузка из истории (ИСПРАВЛЕНА)
    function loadFromHistory() {
        const select = document.getElementById('historySelect');
        const selectedDate = select.value;
        if (!selectedDate) {
            alert("Пожалуйста, выберите дату.");
            return;
        }

        // Исправлено: корректная обработка отсутствия данных
        const historyStr = localStorage.getItem(STORAGE_KEY_HISTORY);
        const history = historyStr ? JSON.parse(historyStr) : {};
        const savedEntry = history[selectedDate];

        if (savedEntry) {
            console.log("Загружаем из истории для даты:", selectedDate, savedEntry);
            // Заполняем поля
            document.getElementById('logDate').value = savedEntry.date;
            predefinedActivities.forEach(activity => {
                const entry = savedEntry.entries[activity.id];
                if (entry) {
                    document.getElementById(`start_${activity.id}`).value = entry.start_time || '';
                    document.getElementById(`end_${activity.id}`).value = entry.end_time || '';
                    document.getElementById(`quality_${activity.id}`).value = entry.quality || '';
                    document.getElementById(`comment_${activity.id}`).value = entry.comment || '';
                }
            });
            // Сохраняем как текущие данные
            saveCurrentToLocalStorage();
        } else {
            alert("Данные для выбранной даты не найдены.");
        }
    }

    // Обновление списка истории (ИСПРАВЛЕНА)
    function updateHistoryList() {
        const select = document.getElementById('historySelect');
        // Очищаем список, кроме первой опции
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }

        // Исправлено: корректная обработка отсутствия данных
        const historyStr = localStorage.getItem(STORAGE_KEY_HISTORY);
        const history = historyStr ? JSON.parse(historyStr) : {};
        
        // Получаем все сохранённые даты
        const dates = Object.keys(history);
        // Сортируем по убыванию (новые даты первыми)
        dates.sort((a, b) => new Date(b) - new Date(a));

        // Добавляем даты в выпадающий список
        dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            select.appendChild(option);
        });
    }

    // --- ИНИЦИАЛИЗАЦИЯ ТАБЛИЦЫ ---
    const tbody = document.getElementById('tbody-content');
    predefinedActivities.forEach(activity => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${activity.name}</td>
            <td>${activity.description}</td>
            <td>
                <input type="text" class="time-input" id="start_${activity.id}" placeholder="ЧЧ:ММ" size="6">
                <button class="now-btn" onclick="setNow('start_${activity.id}')">Now</button>
            </td>
            <td>
                <input type="text" class="time-input" id="end_${activity.id}" placeholder="ЧЧ:ММ" size="6">
                <button class="now-btn" onclick="setNow('end_${activity.id}')">Now</button>
            </td>
            <td>
                <select id="quality_${activity.id}">
                    <option value="">--</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </td>
            <td><input type="text" class="comment-input" id="comment_${activity.id}"></td>
        `;
        tbody.appendChild(row);
    });

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ДЛЯ СОХРАНЕНИЯ ---
    document.querySelectorAll('.time-input, input[type="text"][id^="comment_"], select[id^="quality_"]').forEach(input => {
        input.addEventListener('change', saveCurrentToLocalStorage);
        input.addEventListener('input', saveCurrentToLocalStorage);
    });
    document.getElementById('logDate').addEventListener('change', saveCurrentToLocalStorage);

    // --- ФУНКЦИИ ---
    function setNow(elementId) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        document.getElementById(elementId).value = timeString;
        saveCurrentToLocalStorage();
    }

    function generateJson() {
        const logDate = document.getElementById('logDate').value;
        const entries = {};
        predefinedActivities.forEach(activity => {
            entries[activity.id] = {
                start_time: document.getElementById(`start_${activity.id}`).value || null,
                end_time: document.getElementById(`end_${activity.id}`).value || null,
                quality: document.getElementById(`quality_${activity.id}`).value || null,
                comment: document.getElementById(`comment_${activity.id}`).value || null
            };
        });

        const data = {
            date: logDate,
            activities: predefinedActivities.map(activity => {
                const entry = entries[activity.id];
                return {
                    id: activity.id,
                    name: activity.name,
                    description: activity.description,
                    start_time: entry.start_time,
                    end_time: entry.end_time,
                    quality: entry.quality ? parseInt(entry.quality) : null,
                    comment: entry.comment
                };
            })
        };

        document.getElementById('jsonOutput').value = JSON.stringify(data, null, 2);

        // Сохраняем в историю ТЕКУЩЕЕ состояние полей под выбранной датой
        saveToHistory(logDate, entries);
    }

    function clearAll() {
        document.querySelectorAll('.time-input, input[type="text"][id^="comment_"], select[id^="quality_"]').forEach(input => {
            input.value = '';
        });
        document.getElementById('logDate').value = getCurrentDate();
        saveCurrentToLocalStorage();
        document.getElementById('jsonOutput').value = '';
    }

    function copyToClipboard() {
        const output = document.getElementById('jsonOutput');
        output.select();
        document.execCommand('copy');
        alert('Скопировано в буфер обмена');
    }

    // --- Focus Navigation ---
    const inputs = document.querySelectorAll('.time-input, input.comment-input');
    inputs.forEach((input, index) => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const nextIndex = (index + 1) % inputs.length;
                inputs[nextIndex].focus();
            }
        });
    });

    // --- Отладочные функции ---
    function updateDebugInfo() {
        const contentDiv = document.getElementById('localStorageContent');
        const allItems = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('lifeMetrics')) { // Фильтруем только наши ключи
                allItems[key] = localStorage.getItem(key);
            }
        }
        contentDiv.textContent = JSON.stringify(allItems, null, 2);
    }

    // Загружаем данные при загрузке страницы
    window.onload = loadFromLocalStorage;

</script>

</body>
</html>