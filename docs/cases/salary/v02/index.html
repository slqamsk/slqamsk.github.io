<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор зарплаты с НДФЛ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      background-color: #f0f8ff;
      border-left: 4px solid #007acc;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Калькулятор зарплаты с НДФЛ</h1>
    <p>Введите желаемую зарплату "на руки" в месяц:</p>
    <input type="number" id="desiredSalary" placeholder="Зарплата на руки в месяц" />
    <button onclick="calculateGrossSalary()">Рассчитать зарплату до вычета</button>

    <div id="result" class="result" style="display:none;"></div>
  </div>

  <script>
    const BRACKETS = [
      { limit: 2400000, rate: 0.13 },
      { limit: 5000000, rate: 0.15 },
      { limit: 20000000, rate: 0.18 },
      { limit: 50000000, rate: 0.20 },
      { limit: Infinity, rate: 0.22 }
    ];

    function calculateTax(yearlyIncome) {
      if (yearlyIncome <= 0) return 0;

      let tax = 0;
      let remaining = yearlyIncome;
      let prevLimit = 0;

      for (let i = 0; i < BRACKETS.length; i++) {
        const bracket = BRACKETS[i];
        const taxableInBracket = Math.min(remaining, bracket.limit - prevLimit);

        if (taxableInBracket <= 0) continue;

        if (i === 0) {
          tax += taxableInBracket * 0.13;
        } else if (i === 1) {
          tax += (2400000 - 0) * 0.13; // 312000
          tax += taxableInBracket * 0.15;
        } else if (i === 2) {
          tax += (2400000 - 0) * 0.13; // 312000
          tax += (5000000 - 2400000) * 0.15; // 390000
          tax += taxableInBracket * 0.18;
        } else if (i === 3) {
          tax += (2400000 - 0) * 0.13; // 312000
          tax += (5000000 - 2400000) * 0.15; // 390000
          tax += (20000000 - 5000000) * 0.18; // 2700000
          tax += taxableInBracket * 0.20;
        } else if (i === 4) {
          tax += (2400000 - 0) * 0.13; // 312000
          tax += (5000000 - 2400000) * 0.15; // 390000
          tax += (20000000 - 5000000) * 0.18; // 2700000
          tax += (50000000 - 20000000) * 0.20; // 6000000
          tax += taxableInBracket * 0.22;
        }

        remaining -= taxableInBracket;
        prevLimit = bracket.limit;

        if (remaining <= 0) break;
      }

      return tax;
    }

    function calculateGrossFromNet(netMonthly) {
      let low = netMonthly;
      let high = netMonthly * 5;
      let iterations = 0;

      while (high - low > 0.01 && iterations < 100) {
        const mid = (low + high) / 2;
        const yearlyGross = mid * 12;
        const totalTax = calculateTax(yearlyGross);
        const net = (yearlyGross - totalTax) / 12;

        if (Math.abs(net - netMonthly) < 0.01) {
          return mid;
        } else if (net > netMonthly) {
          high = mid;
        } else {
          low = mid;
        }
        iterations++;
      }

      return (low + high) / 2;
    }

    function breakdownTax(yearlyGross) {
      let tax = 0;
      let breakdown = [];
      let remaining = yearlyGross;
      let prevLimit = 0;

      for (let i = 0; i < BRACKETS.length; i++) {
        const bracket = BRACKETS[i];
        const taxableInBracket = Math.min(remaining, bracket.limit - prevLimit);

        if (taxableInBracket <= 0) continue;

        let rate = bracket.rate;
        let calculatedTax = 0;

        if (i === 0) {
          calculatedTax = taxableInBracket * 0.13;
        } else if (i === 1) {
          calculatedTax = taxableInBracket * 0.15;
        } else if (i === 2) {
          calculatedTax = taxableInBracket * 0.18;
        } else if (i === 3) {
          calculatedTax = taxableInBracket * 0.20;
        } else if (i === 4) {
          calculatedTax = taxableInBracket * 0.22;
        }

        breakdown.push({
          from: prevLimit,
          to: prevLimit + taxableInBracket,
          rate: rate * 100,
          taxable: taxableInBracket,
          tax: calculatedTax
        });

        tax += calculatedTax;
        remaining -= taxableInBracket;
        prevLimit += taxableInBracket;

        if (remaining <= 0) break;
      }

      return { breakdown, totalTax: tax };
    }

    function calculateGrossSalary() {
      const input = document.getElementById("desiredSalary");
      const resultDiv = document.getElementById("result");

      const netMonthly = parseFloat(input.value);

      if (isNaN(netMonthly) || netMonthly <= 0) {
        resultDiv.innerHTML = '<p class="error">Введите корректное значение зарплаты</p>';
        resultDiv.style.display = "block";
        return;
      }

      const grossMonthly = calculateGrossFromNet(netMonthly);
      const yearlyGross = grossMonthly * 12;
      const totalTax = calculateTax(yearlyGross);
      const netCalculated = (yearlyGross - totalTax) / 12;

      const breakdown = breakdownTax(yearlyGross);

      let breakdownHTML = "<ul>";
      breakdown.breakdown.forEach(b => {
        breakdownHTML += `<li>${b.from.toLocaleString()} - ${b.to.toLocaleString()} ₽: ${b.rate}% → Налог: ${b.tax.toFixed(2)} ₽</li>`;
      });
      breakdownHTML += "</ul>";

      resultDiv.innerHTML = `
        <p><strong>Желаемая зарплата на руки (в месяц):</strong> ${netMonthly.toFixed(2)}</p>
        <p><strong>Зарплата до вычета налогов (в месяц):</strong> ${grossMonthly.toFixed(2)}</p>
        <p><strong>Зарплата до вычета налогов (в год):</strong> ${yearlyGross.toFixed(2)}</p>
        <p><strong>Разбивка налога по ставкам:</strong></p>
        ${breakdownHTML}
        <p><strong>Общий налог (в год):</strong> ${totalTax.toFixed(2)}</p>
        <p><strong>Проверка (зарплата на руки после вычета, в месяц):</strong> ${netCalculated.toFixed(2)}</p>
        <p class="${Math.abs(netCalculated - netMonthly) < 0.1 ? 'success' : 'error'}">
          ${Math.abs(netCalculated - netMonthly) < 0.1 ? '✅ Проверка пройдена' : '❌ Проверка не пройдена'}
        </p>
      `;
      resultDiv.style.display = "block";
    }
  </script>
</body>
</html>